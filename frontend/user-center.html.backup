<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户中心 - 灵图智谱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
        }
        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .nav-button.active {
            background-color: #0891b2;
            color: white;
        }
        .nav-button {
            transition: all 0.2s ease;
        }
        .nav-button:hover:not(.active) {
            background-color: #334155;
            color: white;
        }
        .input-field {
            background-color: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #0891b2;
            box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.2);
        }
        .btn-primary {
            background-color: #0891b2;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #0e7490;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #334155;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        #particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
    </style>
</head>
<body class="text-white">
    <!-- 粒子背景容器 -->
    <div id="particles-container"></div>
    
    <!-- 导航栏 -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-slate-900/80 backdrop-blur-md border-b border-slate-700/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold">灵图智谱</span>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="index.html" class="text-slate-300 hover:text-white transition-colors">首页</a>
                    <a href="query.html" class="text-slate-300 hover:text-white transition-colors">知识查询</a>
                    <a href="graph.html" class="text-slate-300 hover:text-white transition-colors">图谱可视</a>
                    <a href="admin.html" class="text-slate-300 hover:text-white transition-colors">系统管理</a>
                    <a href="user-center.html" class="text-cyan-400 hover:text-cyan-300 transition-colors font-medium">用户中心</a>
                    <button onclick="logout()" class="text-slate-300 hover:text-red-400 transition-colors">退出登录</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="pt-24 pb-16 px-4 max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">用户中心</h1>
        
        <!-- 用户中心导航栏 -->
        <div class="card p-4 rounded-xl mb-8">
            <div class="flex flex-wrap gap-2 justify-center">
                <button class="nav-button active px-6 py-3 rounded-lg font-medium" data-target="user-management">
                    用户管理
                </button>
                <button class="nav-button px-6 py-3 rounded-lg bg-slate-700 text-slate-300 font-medium" data-target="personal-info">
                    个人资料
                </button>
                <button class="nav-button px-6 py-3 rounded-lg bg-slate-700 text-slate-300 font-medium" data-target="account-security">
                    账户安全
                </button>
                <button class="nav-button px-6 py-3 rounded-lg bg-slate-700 text-slate-300 font-medium" data-target="notification-settings">
                    通知设置
                </button>
            </div>
        </div>
        
        <!-- 用户管理模块 -->
        <div id="user-management" class="content-section card p-6 rounded-xl">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 class="text-2xl font-semibold">用户列表</h2>
                <button id="addUserBtn" class="btn-primary px-5 py-2 rounded-lg font-medium flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    添加用户
                </button>
            </div>
            
            <!-- 搜索和筛选 -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <div class="relative flex-1">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="搜索用户..." class="input-field w-full pl-10 pr-4 py-2 rounded-lg text-white">
                </div>
                <select id="filterSelect" class="input-field px-4 py-2 rounded-lg text-white">
                    <option value="all">所有用户</option>
                    <option value="active">活跃用户</option>
                    <option value="inactive">非活跃用户</option>
                </select>
            </div>
            
            <!-- 用户列表 -->
            <div id="userList" class="space-y-4">
                <!-- 用户列表将动态生成 -->
            </div>
            
            <!-- 分页 -->
            <div id="pagination" class="flex justify-center mt-8">
                <div class="flex items-center space-x-2">
                    <button id="prevPage" class="btn-secondary px-4 py-2 rounded-lg">上一页</button>
                    <span id="currentPage" class="px-4 py-2">1</span>
                    <button id="nextPage" class="btn-secondary px-4 py-2 rounded-lg">下一页</button>
                </div>
            </div>
        </div>
        
        <!-- 添加用户模态框 -->
        <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-slate-900 rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">添加用户</h3>
                    <button id="closeAddModal" class="text-slate-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <form id="addUserForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">用户名</label>
                        <input type="text" name="username" required class="input-field w-full px-4 py-2 rounded-lg text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">邮箱</label>
                        <input type="email" name="email" required class="input-field w-full px-4 py-2 rounded-lg text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">密码</label>
                        <input type="password" name="password" required class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="密码必须包含大小写字母和数字">
                        <p class="text-xs text-slate-500 mt-1">密码必须包含大小写字母和数字</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-slate-300 mb-2">验证码</label>
                            <input type="text" name="verification_code" class="input-field w-full px-4 py-2 rounded-lg text-white" placeholder="请输入验证码">
                        </div>
                        <div class="sm:col-span-1 flex items-end">
                            <button type="button" id="sendVerificationCode" class="btn-secondary w-full px-4 py-2 rounded-lg">
                                发送验证码
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">角色</label>
                        <select name="role" class="input-field w-full px-4 py-2 rounded-lg text-white">
                            <option value="USER">普通用户</option>
                            <option value="ADMIN">管理员</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancelAdd" class="btn-secondary px-6 py-2 rounded-lg">取消</button>
                        <button type="submit" class="btn-primary px-6 py-2 rounded-lg">添加用户</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 编辑用户模态框 -->
        <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-slate-900 rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">编辑用户</h3>
                    <button id="closeEditModal" class="text-slate-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <form id="editUserForm" class="space-y-4">
                    <input type="hidden" name="userId">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">用户名</label>
                        <input type="text" name="username" required class="input-field w-full px-4 py-2 rounded-lg text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">邮箱</label>
                        <input type="email" name="email" required class="input-field w-full px-4 py-2 rounded-lg text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">角色</label>
                        <select name="role" class="input-field w-full px-4 py-2 rounded-lg text-white">
                            <option value="USER">普通用户</option>
                            <option value="ADMIN">管理员</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancelEdit" class="btn-secondary px-6 py-2 rounded-lg">取消</button>
                        <button type="submit" class="btn-primary px-6 py-2 rounded-lg">保存修改</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 个人资料模块 -->
        <div id="personal-info" class="content-section card p-6 rounded-xl hidden">
            <h2 class="text-2xl font-semibold mb-6">个人资料</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1">
                    <div class="flex flex-col items-center">
                        <div class="relative mb-4">
                            <img src="resources/avatars/user1.jpg" alt="用户头像" class="w-32 h-32 rounded-full object-cover border-4 border-slate-700" />
                            <button class="absolute bottom-0 right-0 w-8 h-8 bg-cyan-600 rounded-full flex items-center justify-center text-white">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <h3 class="text-xl font-semibold mb-1">管理员</h3>
                        <p class="text-slate-400 mb-4">admin@example.com</p>
                        <button class="btn-primary w-full py-2 rounded-lg">上传头像</button>
                    </div>
                </div>
                
                <div class="md:col-span-2">
                    <form class="space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">用户名</label>
                                <input type="text" value="管理员" class="input-field w-full px-4 py-2 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">邮箱</label>
                                <input type="email" value="admin@example.com" class="input-field w-full px-4 py-2 rounded-lg text-white">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">手机号码</label>
                                <input type="tel" value="13800138000" class="input-field w-full px-4 py-2 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">用户角色</label>
                                <input type="text" value="管理员" disabled class="input-field w-full px-4 py-2 rounded-lg text-slate-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">个人简介</label>
                            <textarea rows="4" class="input-field w-full px-4 py-2 rounded-lg text-white">系统管理员，负责系统的日常维护和管理工作。</textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="button" class="btn-secondary px-6 py-2 rounded-lg">取消</button>
                            <button type="submit" class="btn-primary px-6 py-2 rounded-lg">保存修改</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 账户安全模块 -->
        <div id="account-security" class="content-section card p-6 rounded-xl hidden">
            <h2 class="text-2xl font-semibold mb-6">账户安全</h2>
            
            <div class="space-y-6">
                <div class="card p-5 rounded-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-medium mb-1">修改密码</h3>
                            <p class="text-sm text-slate-400">建议定期更换密码，确保账户安全</p>
                        </div>
                        <button class="btn-primary px-5 py-2 rounded-lg self-start sm:self-auto">
                            修改密码
                        </button>
                    </div>
                </div>
                
                <div class="card p-5 rounded-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-medium mb-1">邮箱验证</h3>
                            <p class="text-sm text-slate-400">admin@example.com</p>
                        </div>
                        <div class="flex items-center space-x-3 self-start sm:self-auto">
                            <span class="px-2 py-1 bg-green-900/50 text-green-400 rounded-full text-sm">已验证</span>
                            <button class="btn-secondary px-5 py-2 rounded-lg">重新验证</button>
                        </div>
                    </div>
                </div>
                
                <div class="card p-5 rounded-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-medium mb-1">手机验证</h3>
                            <p class="text-sm text-slate-400">138****8000</p>
                        </div>
                        <div class="flex items-center space-x-3 self-start sm:self-auto">
                            <span class="px-2 py-1 bg-green-900/50 text-green-400 rounded-full text-sm">已验证</span>
                            <button class="btn-secondary px-5 py-2 rounded-lg">更换手机</button>
                        </div>
                    </div>
                </div>
                
                <div class="card p-5 rounded-lg" id="mfa-status-card">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-medium mb-1">双因素认证</h3>
                            <p class="text-sm text-slate-400">开启后登录时需要额外验证</p>
                        </div>
                        <div class="flex items-center space-x-3 self-start sm:self-auto">
                            <span id="mfa-status" class="px-2 py-1 bg-red-900/50 text-red-400 rounded-full text-sm">未开启</span>
                            <button class="btn-primary px-5 py-2 rounded-lg">开启</button>
                        </div>
                    </div>
                </div>
                
                <div class="card p-5 rounded-lg">
                    <h3 class="text-lg font-medium mb-4">登录历史</h3>
                    <div id="login-history-list" class="space-y-4">
                        <!-- 登录历史将动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 通知设置模块 -->
        <div id="notification-settings" class="content-section card p-6 rounded-xl hidden">
            <h2 class="text-2xl font-semibold mb-6">通知设置</h2>
            
            <div class="space-y-6">
                <div class="card p-5 rounded-lg">
                    <h3 class="text-lg font-medium mb-4">系统通知</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="font-medium">系统公告</label>
                                <p class="text-sm text-slate-400">接收系统重要公告和更新信息</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                            </label>
                        </div>
                        
                        <div class="border-t border-slate-700 pt-4 flex items-center justify-between">
                            <div>
                                <label class="font-medium">操作日志提醒</label>
                                <p class="text-sm text-slate-400">接收账户重要操作日志通知</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                            </label>
                        </div>
                        
                        <div class="border-t border-slate-700 pt-4 flex items-center justify-between">
                            <div>
                                <label class="font-medium">数据更新提醒</label>
                                <p class="text-sm text-slate-400">接收数据更新和同步完成通知</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="card p-5 rounded-lg">
                    <h3 class="text-lg font-medium mb-4">接收方式</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="font-medium">站内通知</label>
                                <p class="text-sm text-slate-400">在系统内接收通知消息</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                            </label>
                        </div>
                        
                        <div class="border-t border-slate-700 pt-4 flex items-center justify-between">
                            <div>
                                <label class="font-medium">邮件通知</label>
                                <p class="text-sm text-slate-400">通过邮件接收重要通知</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                            </label>
                        </div>
                        
                        <div class="border-t border-slate-700 pt-4 flex items-center justify-between">
                            <div>
                                <label class="font-medium">短信通知</label>
                                <p class="text-sm text-slate-400">通过短信接收紧急通知</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button class="btn-primary px-6 py-2 rounded-lg">保存设置</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API基础URL
        const API_BASE_URL = 'http://localhost:8000';
        
        // 获取JWT Token
        function getToken() {
            return localStorage.getItem('access_token');
        }
        
        // 检查用户是否已登录
        function checkLogin() {
            const token = getToken();
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }
        
        // API请求函数
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const token = getToken();
            const headers = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            
            const options = {
                method,
                headers
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (response.status === 401) {
                    // Token过期或无效，跳转到登录页
                    window.location.href = 'login.html';
                    return null;
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `API请求失败: ${response.status}`);
                }
                
                // 对于204 No Content响应，直接返回null
                if (response.status === 204) {
                    return null;
                }
                
                return await response.json();
            } catch (error) {
                console.error('API请求错误:', error);
                // 不显示alert，避免频繁打扰用户
                return null;
            }
        }
        
        // 获取双因素认证状态
        async function getMfaStatus() {
            return await apiRequest('/api/users/me/mfa-status');
        }
        
        // 获取登录历史
        async function getLoginHistory() {
            return await apiRequest('/api/users/me/login-history?limit=10');
        }
        
        // 更新双因素认证状态显示
        function updateMfaStatusUI(status) {
            const mfaStatusElement = document.getElementById('mfa-status');
            if (mfaStatusElement) {
                if (status.mfa_enabled) {
                    mfaStatusElement.className = 'px-2 py-1 bg-green-900/50 text-green-400 rounded-full text-sm';
                    mfaStatusElement.textContent = '已开启';
                } else {
                    mfaStatusElement.className = 'px-2 py-1 bg-red-900/50 text-red-400 rounded-full text-sm';
                    mfaStatusElement.textContent = '未开启';
                }
            }
        }
        
        // 更新登录历史显示
        function updateLoginHistoryUI(loginHistory) {
            const loginHistoryList = document.getElementById('login-history-list');
            if (loginHistoryList) {
                if (!loginHistory || loginHistory.length === 0) {
                    loginHistoryList.innerHTML = '<p class="text-slate-400 text-center py-4">暂无登录历史</p>';
                    return;
                }
                
                loginHistoryList.innerHTML = loginHistory.map(item => {
                    // 格式化日期
                    const loginTime = new Date(item.login_time).toLocaleString();
                    const logoutTime = item.logout_time ? new Date(item.logout_time).toLocaleString() : '';
                    
                    // 解析设备信息
                    let deviceInfo = item.device_info || '';
                    let browserInfo = '';
                    let osInfo = '';
                    
                    // 简单的UA解析（实际应用中应该使用更专业的库）
                    const ua = item.user_agent;
                    if (ua.includes('Windows')) {
                        osInfo = 'Windows';
                    } else if (ua.includes('Mac')) {
                        osInfo = 'Mac OS X';
                    } else if (ua.includes('Android')) {
                        osInfo = 'Android';
                    } else if (ua.includes('iOS')) {
                        osInfo = 'iOS';
                    }
                    
                    if (ua.includes('Chrome')) {
                        browserInfo = 'Chrome';
                    } else if (ua.includes('Safari')) {
                        browserInfo = 'Safari';
                    } else if (ua.includes('Firefox')) {
                        browserInfo = 'Firefox';
                    } else if (ua.includes('Edge')) {
                        browserInfo = 'Edge';
                    }
                    
                    deviceInfo = `${osInfo} · ${browserInfo}`.trim();
                    
                    return `
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between text-sm">
                            <div>
                                <p class="mb-1">${loginTime}</p>
                                <p class="text-slate-400">${deviceInfo} · ${item.ip_address} · ${item.location}</p>
                            </div>
                            <span class="text-${item.is_current ? 'green' : 'slate'}-400 mt-2 sm:mt-0">${item.is_current ? '当前登录' : '已下线'}</span>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // 获取用户列表
        async function getUsers(page = 1, limit = 10, search = '', status = 'all') {
            let endpoint = `/api/users?skip=${(page - 1) * limit}&limit=${limit}`;
            if (search) {
                endpoint += `&search=${encodeURIComponent(search)}`;
            }
            if (status !== 'all') {
                endpoint += `&status=${status}`;
            }
            return await apiRequest(endpoint);
        }
        
        // 获取用户详情
        async function getUser(userId) {
            return await apiRequest(`/api/users/${userId}`);
        }
        
        // 发送验证码
        async function sendVerificationCode(email) {
            try {
                const token = getToken();
                const response = await fetch(`${API_BASE_URL}/api/auth/send-verification-code`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, purpose: 'register' })
                });
                
                if (response.status === 401) {
                    window.location.href = 'login.html';
                    return null;
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || '发送验证码失败');
                }
                
                return await response.json();
            } catch (error) {
                console.error('发送验证码错误:', error);
                alert(`发送验证码失败: ${error.message}`);
                return null;
            }
        }

        // 创建用户
        async function createUser(userData) {
            return await apiRequest('/api/auth/register', 'POST', userData);
        }
        
        // 更新用户
        async function updateUser(userId, userData) {
            return await apiRequest(`/api/users/${userId}`, 'PUT', userData);
        }
        
        // 删除用户
        async function deleteUser(userId) {
            return await apiRequest(`/api/users/${userId}`, 'DELETE');
        }
        
        // 渲染用户列表
        function renderUserList(users) {
            const userList = document.getElementById('userList');
            
            if (!users || users.length === 0) {
                userList.innerHTML = '<p class="text-slate-400 text-center py-8">暂无用户数据</p>';
                return;
            }
            
            userList.innerHTML = users.map(user => `
                <div class="card p-4 rounded-lg" data-user-id="${user.id}">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <img src="resources/avatars/user1.jpg" alt="${user.username}" class="w-12 h-12 rounded-full object-cover" />
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-slate-900"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                <div>
                                    <p class="font-medium text-white truncate">${user.username}</p>
                                    <p class="text-sm text-slate-400 truncate">${user.email}</p>
                                </div>
                                <div class="text-sm">
                                    <span class="px-2 py-0.5 bg-cyan-900/50 text-cyan-400 rounded-full">${user.role || '普通用户'}</span>
                                    <span class="ml-2 text-slate-400">在线</span>
                                </div>
                            </div>
                            <div class="mt-3 text-sm text-slate-400">
                                <span>最后登录: ${new Date(user.updated_at).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="p-2 text-slate-400 hover:text-cyan-400 transition-colors" onclick="editUser('${user.id}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            <button class="p-2 text-slate-400 hover:text-red-400 transition-colors" onclick="deleteUserConfirm('${user.id}', '${user.username}')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 加载用户列表
        async function loadUsers(page = 1) {
            const search = document.getElementById('searchInput').value;
            const status = document.getElementById('filterSelect').value;
            
            const users = await getUsers(page, 10, search, status);
            if (users) {
                renderUserList(users);
                document.getElementById('currentPage').textContent = page;
            }
        }
        
        // 编辑用户
        async function editUser(userId) {
            const user = await getUser(userId);
            if (user) {
                document.querySelector('#editUserForm input[name="userId"]').value = user.id;
                document.querySelector('#editUserForm input[name="username"]').value = user.username;
                document.querySelector('#editUserForm input[name="email"]').value = user.email;
                document.querySelector('#editUserForm select[name="role"]').value = user.role || 'USER';
                document.getElementById('editUserModal').classList.remove('hidden');
            }
        }
        
        // 删除用户确认
        function deleteUserConfirm(userId, username) {
            if (confirm(`确定要删除用户「${username}」吗？此操作不可撤销。`)) {
                // 先从DOM中移除该用户，提供即时视觉反馈
                const userElement = document.querySelector(`[data-user-id="${userId}"]`);
                if (userElement) {
                    userElement.remove();
                }
                
                deleteUser(userId)
                    .then(result => {
                        // 204 No Content响应会返回null，这表示删除成功
                        alert(`用户「${username}」已删除`);
                        // 重新加载用户列表，确保数据一致性
                        loadUsers();
                    })
                    .catch(error => {
                        console.error('删除用户失败:', error);
                        // 如果删除失败，重新加载用户列表，恢复被移除的用户
                        loadUsers();
                        alert(`删除用户「${username}」失败: ${error.message}`);
                    });
            }
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            checkLogin();
            
            // 导航切换功能
            const navButtons = document.querySelectorAll('.nav-button');
            const contentSections = document.querySelectorAll('.content-section');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的active状态
                    navButtons.forEach(btn => {
                        btn.classList.remove('active', 'bg-cyan-600', 'text-white');
                        btn.classList.add('bg-slate-700', 'text-slate-300');
                    });
                    
                    // 激活当前按钮
                    this.classList.add('active', 'bg-cyan-600', 'text-white');
                    this.classList.remove('bg-slate-700', 'text-slate-300');
                    
                    // 隐藏所有内容区域
                    contentSections.forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    // 显示对应内容区域
                    const target = this.getAttribute('data-target');
                    const targetSection = document.getElementById(target);
                    targetSection.classList.remove('hidden');
                    
                    // 如果是用户管理模块，加载用户列表
                    if (target === 'user-management') {
                        loadUsers();
                    }
                    
                    // 如果是账户安全模块，加载MFA状态和登录历史
                    if (target === 'account-security') {
                        updateAccountSecurityData();
                    }
                });
            });
            
            // 初始加载用户列表（如果当前显示的是用户管理模块）
            if (!document.getElementById('user-management').classList.contains('hidden')) {
                loadUsers();
            }
            
            // 初始加载账户安全数据（如果当前显示的是账户安全模块）
            if (!document.getElementById('account-security').classList.contains('hidden')) {
                updateAccountSecurityData();
            }
            
            // 添加用户按钮
            document.getElementById('addUserBtn').addEventListener('click', function() {
                document.getElementById('addUserModal').classList.remove('hidden');
            });
            
            // 发送验证码按钮
            document.getElementById('sendVerificationCode').addEventListener('click', function() {
                const email = document.querySelector('#addUserForm input[name="email"]').value;
                if (!email) {
                    alert('请先输入邮箱地址');
                    return;
                }
                
                // 简单的邮箱格式验证
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('请输入有效的邮箱地址');
                    return;
                }
                
                // 禁用按钮，防止重复点击
                const button = this;
                button.disabled = true;
                button.textContent = '发送中...';
                
                sendVerificationCode(email).then(result => {
                    if (result) {
                        alert('验证码已发送到您的邮箱');
                        // 60秒后恢复按钮
                        let countdown = 60;
                        const timer = setInterval(() => {
                            countdown--;
                            button.textContent = `${countdown}秒后重试`;
                            if (countdown <= 0) {
                                clearInterval(timer);
                                button.disabled = false;
                                button.textContent = '发送验证码';
                            }
                        }, 1000);
                    } else {
                        button.disabled = false;
                        button.textContent = '发送验证码';
                    }
                });
            });
            
            // 关闭模态框
            document.getElementById('closeAddModal').addEventListener('click', function() {
                document.getElementById('addUserModal').classList.add('hidden');
                document.getElementById('addUserForm').reset();
            });
            
            document.getElementById('cancelAdd').addEventListener('click', function() {
                document.getElementById('addUserModal').classList.add('hidden');
                document.getElementById('addUserForm').reset();
            });
            
            document.getElementById('closeEditModal').addEventListener('click', function() {
                document.getElementById('editUserModal').classList.add('hidden');
                document.getElementById('editUserForm').reset();
            });
            
            document.getElementById('cancelEdit').addEventListener('click', function() {
                document.getElementById('editUserModal').classList.add('hidden');
                document.getElementById('editUserForm').reset();
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('addUserModal')) {
                    document.getElementById('addUserModal').classList.add('hidden');
                    document.getElementById('addUserForm').reset();
                }
                if (e.target === document.getElementById('editUserModal')) {
                    document.getElementById('editUserModal').classList.add('hidden');
                    document.getElementById('editUserForm').reset();
                }
            });
            
            // 添加用户表单提交
            document.getElementById('addUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const userData = {
                    username: formData.get('username'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    role: formData.get('role'),
                    verification_code: formData.get('verification_code')
                };
                
                try {
                    const token = getToken();
                    const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                    
                    if (response.status === 401) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.detail || '添加用户失败');
                    }
                    
                    alert('用户添加成功');
                    document.getElementById('addUserModal').classList.add('hidden');
                    this.reset();
                    loadUsers();
                } catch (error) {
                    console.error('添加用户错误:', error);
                    alert(`添加用户失败: ${error.message}`);
                }
            });
            
            // 编辑用户表单提交
            document.getElementById('editUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const userId = formData.get('userId');
                const userData = {
                    username: formData.get('username'),
                    email: formData.get('email'),
                    role: formData.get('role')
                };
                
                const result = await updateUser(userId, userData);
                if (result) {
                    alert('用户更新成功');
                    document.getElementById('editUserModal').classList.add('hidden');
                    this.reset();
                    loadUsers();
                }
            });
            
            // 搜索功能
            document.getElementById('searchInput').addEventListener('input', function() {
                loadUsers();
            });
            
            // 筛选功能
            document.getElementById('filterSelect').addEventListener('change', function() {
                loadUsers();
            });
            
            // 分页功能
            document.getElementById('prevPage').addEventListener('click', function() {
                const currentPage = parseInt(document.getElementById('currentPage').textContent);
                if (currentPage > 1) {
                    loadUsers(currentPage - 1);
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', function() {
                const currentPage = parseInt(document.getElementById('currentPage').textContent);
                loadUsers(currentPage + 1);
            });
            
            // 个人资料模块交互
            // 上传头像按钮
            document.querySelector('#personal-info .btn-primary').addEventListener('click', function() {
                alert('请选择要上传的头像图片');
            });
            
            // 保存修改按钮
            document.querySelector('#personal-info button[type="submit"]').addEventListener('click', function(e) {
                e.preventDefault();
                alert('个人资料已保存');
            });
            
            // 取消按钮
            document.querySelector('#personal-info button[type="button"]').addEventListener('click', function() {
                if (confirm('确定要取消修改吗？未保存的更改将会丢失。')) {
                    alert('已取消修改');
                }
            });
            
            // 账户安全模块交互
            // 修改密码按钮
            document.querySelector('#account-security .btn-primary:first-of-type').addEventListener('click', function() {
                alert('修改密码功能待实现');
            });
            
            // 重新验证按钮
            document.querySelector('#account-security .btn-secondary').addEventListener('click', function() {
                alert('验证邮件已发送，请查收邮件并完成验证');
            });
            
            // 更换手机按钮
            document.querySelectorAll('#account-security .btn-secondary')[1].addEventListener('click', function() {
                alert('更换手机功能待实现');
            });
            
            // 开启双因素认证按钮
            document.querySelector('#account-security .btn-primary:last-of-type').addEventListener('click', function() {
                alert('双因素认证功能待实现');
            });
            
            // 通知设置模块交互
            // 保存设置按钮
            document.querySelector('#notification-settings .btn-primary').addEventListener('click', function() {
                alert('通知设置已保存');
            });
        });

        // 退出登录功能
        function logout() {
            // 清除localStorage中的token
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            // 重定向到登录页面
            window.location.href = '/login';
        }
    </script>
    
    <!-- 引入粒子背景特效 -->
    <script src="main.js"></script>
</body>
</html>