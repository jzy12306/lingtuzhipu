# 邮箱账户系统优化方案（Google式注册流程）

理解您的需求，以下是重新设计的方案，采用类似Google账号的注册流程，要求用户在注册过程中必须设置密码，同时保留邮箱验证的核心安全机制。

## 核心设计原则

- **邮箱为身份**：邮箱作为唯一身份标识
- **密码必设原则**：注册过程必须设置强密码
- **邮箱验证为主**：关键操作通过邮箱验证码授权
- **双重保障**：日常登录使用密码，敏感操作使用邮箱验证

## 优化后的功能架构

### 1. 用户注册流程（Google式强制密码设置）
```
输入邮箱 → 发送验证 → 验证邮箱所有权 → 设置强密码 → 确认密码 → 完成注册
```

**详细步骤**：
1. 用户输入邮箱地址
2. 系统发送验证码至该邮箱
3. 用户输入验证码，验证邮箱所有权
4. **强制步骤**：设置符合安全要求的密码（至少8位，含大小写字母+数字+符号）
5. 确认密码
6. 注册成功，发送欢迎邮件（包含账户安全提示）

**关键设计**：
- 防刷机制：同一邮箱60秒内只能请求一次验证码，24小时内不超过10次
- 验证码时效：5分钟有效期
- 密码强度实时验证：提供可视化强度指示
- 重复注册检查：如果邮箱已存在，提示"该邮箱已注册"

### 2. 用户登录流程（主次分明）

#### 主要登录方式：邮箱+密码
```
输入邮箱 → 输入密码 → [风险评估] → 登录成功
```
- **默认登录方式**：类似Google的邮箱+密码登录
- **智能风险控制**：
  - 低风险（常用设备/地点）：直接登录
  - 中高风险（新设备/异地）：要求邮箱二次验证

#### 备用登录方式：邮箱+验证码
```
点击"忘记密码" → 发送验证码 → 验证身份 → 临时登录/重置密码
```
- 位置：在登录界面提供"无法访问账户？"链接
- 用途：忘记密码或无法使用密码登录时的应急方案

### 3. 账户安全流程

#### 密码修改
```
登录账户 → 进入安全设置 → 验证当前密码 → 设置新密码 → [高风险操作]邮箱确认
```

#### 账户恢复/找回
```
输入邮箱 → 验证身份(通过备用邮箱/手机/安全问题) → 重置密码 → 邮箱确认
```

#### 高安全操作（修改邮箱、删除账户等）
```
发起操作 → 发送验证码到当前邮箱 → 验证通过 → 执行操作
```
- 无论登录方式如何，关键操作必须通过邮箱验证
- 操作完成后向新旧邮箱发送通知

## 安全策略升级

### 1. 密码安全
- **强制策略**：
  - 最小长度8字符
  - 必须包含大写字母、小写字母、数字和特殊字符中的至少3种
  - 不允许使用常见弱密码（如123456、password等）
  - 90天强制密码更新（可选配置）

- **存储安全**：
  ```python
  # 密码哈希存储示例
  password_hash = bcrypt.hashpw(input_password.encode(), bcrypt.gensalt(rounds=12))
  ```

### 2. 风险感知登录
```python
def login_risk_assessment(user, ip, device):
    risk_score = 0
    
    # 检查是否为新设备
    if not is_known_device(user, device):
        risk_score += 30
        
    # 检查是否为异常地点
    if not is_familiar_location(user, ip):
        risk_score += 40
        
    # 检查登录频率
    if is_unusual_login_frequency(user):
        risk_score += 20
        
    return risk_score > 50  # 风险评分超过阈值需要二次验证
```

### 3. 会话管理
- **活跃会话**：密码登录保持30天
- **会话同步**：用户可在账户设置中查看并管理所有活跃会话
- **异常登出**：当检测到高风险活动时，强制所有会话重新验证

## 用户体验优化

### 1. 注册流程引导
- 分步指示：清晰的三步流程（验证邮箱→设置密码→完成）
- 密码要求可视化：实时显示密码强度
- 预防输入错误：密码确认前提供"显示密码"选项

### 2. 登录界面设计
- 主要区域：邮箱和密码输入框
- 次要选项："无法访问账户？"链接放置在登录按钮下方
- 智能记忆：记住上次使用的邮箱，但不记住密码

### 3. 安全恢复体验
- 多重恢复选项：当用户无法登录时，提供多种身份验证方式
- 渐进式恢复：先验证基本信息，再逐步获取账户控制权
- 恢复后强制安全检查：要求更新密码并验证联系信息

## 数据库示例结构

```sql
-- 用户表
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,  -- 不再是可选字段
    email_verified BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    last_login_at TIMESTAMP,
    security_level INTEGER DEFAULT 1  -- 安全级别
);

-- 密码历史表（防止重复使用）
CREATE TABLE password_history (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 设备信任表
CREATE TABLE trusted_devices (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    device_fingerprint TEXT NOT NULL,
    last_used TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 迁移与部署策略

1. **新用户注册**：完全采用新流程，强制设置密码
2. **现有用户过渡**：
   - 首次登录时引导设置密码
   - 30天过渡期内允许原登录方式
   - 过渡期后强制使用密码登录