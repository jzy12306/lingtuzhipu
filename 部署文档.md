# 多智能体知识图谱系统部署文档

## 系统概述
本文档提供了多智能体知识图谱系统的部署指南，包括环境准备、容器化部署、配置说明和运维建议。

## 系统架构
- **前端**：React + TypeScript
- **后端**：FastAPI + Python 3.10
- **数据库**：SQLite（默认，可配置为PostgreSQL）
- **缓存/消息队列**：Redis
- **容器化**：Docker + Docker Compose

## 部署方式

### 方法一：Docker Compose部署（推荐）

#### 1. 环境准备
- 安装Docker: https://docs.docker.com/get-docker/
- 安装Docker Compose: https://docs.docker.com/compose/install/

#### 2. 配置修改

修改项目根目录下的`docker-compose.yml`文件中的环境变量：

```yaml
# 关键配置项
environment:
  - ENVIRONMENT=production       # 环境设置
  - DEBUG=False                  # 调试模式
  - SECRET_KEY=your-secret-key   # 更换为安全的密钥
  - DB_URL=sqlite:///./app.db    # 数据库连接URL
```

#### 3. 构建并启动服务

在项目根目录执行以下命令：

```bash
docker-compose up -d --build
```

这将：
- 构建后端和前端服务的Docker镜像
- 启动所有服务（后端、前端、Redis）
- 服务将在后台运行

#### 4. 验证部署

- 前端访问：http://localhost:80
- 后端API访问：http://localhost:8000
- 健康检查：http://localhost:80/health

### 方法二：手动部署

#### 后端部署

1. **安装Python依赖**：

```bash
cd backend
pip install -r requirements.txt
```

2. **配置环境变量**：

创建`.env`文件：

```
ENVIRONMENT=production
DEBUG=False
DB_URL=sqlite:///./app.db
SECRET_KEY=your-secret-key
CORS_ORIGINS=http://localhost:3000
```

3. **启动后端服务**：

```bash
uvicorn src.main:app --host 0.0.0.0 --port 8000
```

#### 前端部署

1. **安装Node.js依赖**：

```bash
cd frontend
npm install
```

2. **构建前端应用**：

```bash
npm run build
```

3. **部署静态文件**：

将`dist`目录下的文件部署到Nginx或其他Web服务器。

## 配置说明

### 后端配置项

| 配置项 | 说明 | 默认值 | 建议值 |
|-------|------|--------|-------|
| ENVIRONMENT | 运行环境 | production | production/testing/development |
| DEBUG | 调试模式 | False | 生产环境设为False |
| DB_URL | 数据库连接URL | sqlite:///./app.db | 根据实际数据库配置 |
| SECRET_KEY | 安全密钥 | your-secret-key | 使用强随机密钥 |
| CORS_ORIGINS | CORS允许的源 | http://localhost:3000 | 包含所有前端域名 |
| RATE_LIMIT_ENABLED | 是否启用速率限制 | True | 生产环境设为True |
| RATE_LIMIT_PER_MINUTE | 每分钟请求限制 | 60 | 根据实际情况调整 |
| RATE_LIMIT_PER_HOUR | 每小时请求限制 | 1000 | 根据实际情况调整 |

### 前端配置项

前端配置通过环境变量在构建时注入，主要配置API地址：

```
VITE_API_BASE_URL=http://localhost:8000/api
```

## 数据备份与恢复

### SQLite数据库备份

```bash
# 备份数据库
docker cp backend:/app/app.db ./backups/app_backup_$(date +%Y%m%d).db

# 恢复数据库
docker cp ./backups/app_backup_20240626.db backend:/app/app.db
docker restart backend
```

### 文件备份

```bash
# 备份数据卷
docker run --rm -v backend-data:/data -v $(pwd)/backups:/backup alpine \
  tar -czvf /backup/backend_data_backup_$(date +%Y%m%d).tar.gz /data

# 备份日志
docker run --rm -v backend-logs:/logs -v $(pwd)/backups:/backup alpine \
  tar -czvf /backup/logs_backup_$(date +%Y%m%d).tar.gz /logs
```

## 日志管理

### 查看日志

```bash
# 查看后端日志
docker logs backend

# 查看前端日志
docker logs frontend

# 查看Redis日志
docker logs redis
```

### 日志文件

- 后端日志：`/app/logs/`目录（挂载到`backend-logs`数据卷）
- 前端Nginx日志：容器内的`/var/log/nginx/`目录

## 常见问题处理

### 服务启动失败

1. 检查Docker服务是否正常运行：
   ```bash
systemctl status docker
   ```

2. 查看容器日志：
   ```bash
docker logs <容器名>
   ```

3. 确认端口未被占用：
   ```bash
netstat -tlnp | grep 8000  # 检查后端端口
netstat -tlnp | grep 80    # 检查前端端口
   ```

### 前端无法连接后端API

1. 确认CORS配置包含前端域名
2. 检查后端服务是否正常运行
3. 验证网络连接：
   ```bash
docker exec frontend curl http://backend:8000
   ```

## 性能监控

### 容器资源监控

```bash
# 查看所有容器状态
docker stats

# 查看特定容器资源使用
docker stats backend
```

### 系统监控建议

推荐使用Prometheus + Grafana进行系统监控，可以监控：
- API响应时间
- 请求量
- 错误率
- 资源使用率

## 更新部署

### 更新代码后重新部署

```bash
# 拉取最新代码
git pull

# 重新构建并启动服务
docker-compose up -d --build
```

## 安全建议

1. 生产环境必须更换默认的SECRET_KEY
2. 配置HTTPS
3. 定期更新依赖包
4. 限制外部访问Redis端口
5. 定期备份数据
6. 监控异常登录和请求

## 联系方式

如有部署问题，请联系系统管理员：admin@example.com